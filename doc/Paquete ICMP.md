# Análisis de paquetes ICMP

Para capturar paquetes usar `tcpdump`

```bash
sudo tcpdump -i any -X icmp
```
Ejecutar `ft_ping`

```bash
sudo ./ft_ping -c 1 -p ff 8.8.8.8
```

## Paquete ICMP (84 bytes)
```
┌─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┐
│          0          │          1          │          2          │          3          │
└─────────────────────┴─────────────────────┴─────────────────────┴─────────────────────┘
┌=======================================================================================┐
│                                IP Header (20/60 bytes)                                │
├──────────┬──────────┬───────────────┬─────┬───────────────────────────────────────────┤
│ Version  │   IHL    │   DSCP        │ ECN │               Total Length                │
├──────────┴──────────┴───────────────┴─────┼───────┬───────────────────────────────────┤
│              Identification               │ Flags │          Fragment Offset          │
├─────────────────────┬─────────────────────┼───────┴───────────────────────────────────┤
│    Time to Live     │      Protocol       │              Header Checksum              │
├─────────────────────┴─────────────────────┴───────────────────────────────────────────┤
│                                    Source Address                                     │
├───────────────────────────────────────────────────────────────────────────────────────┤
│                                  Destination Address                                  │
├───────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                       │
│                                        Options                                        │
│                                                                                       │
├=======================================================================================┤
│                                 ICMP Header (8 bytes)                                 │ 
├─────────────────────┬─────────────────────┬───────────────────────────────────────────┤
│        Type         │        Code         │                 Checksum                  │
├─────────────────────┴─────────────────────┴───────────────────────────────────────────┤
│   ┌───────────────────────────────────────┬───────────────────────────────────────┐   │
├─> │                  ID                   │               Sequence                │ <─┤
│   └───────────────────────────────────────┴───────────────────────────────────────┘   │
│   ┌───────────────────────────────────────────────────────────────────────────────┐   │
├─> │                                    Gateway                                    │ <─┤
│   └───────────────────────────────────────────────────────────────────────────────┘   │
│   ┌───────────────────────────────────────┬───────────────────────────────────────┐   │
├─> │                Unused                 │                  MTU                  │ <─┤
│   └───────────────────────────────────────┴───────────────────────────────────────┘   │
├=======================================================================================┤
│                                   Payload (56 bytes)                                  │
├───────────────────────────────────────────┬───────────────────────────────────────────┤
│                 Timestamp                 │                                           │
├───────────────────────────────────────────┘                                           │
│                                                                                       │
│                                Payload data (48 bytes)                                │
│                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

## ICMP Echo Request (ping saliente)

```
15:34:09.869369 eth0  Out IP 172.31.191.101 > dns.google: ICMP echo request, id 56026, seq 6, length 64
│               │     │   │                   │           │                  │         │      │
│               │     │   │                   │           │                  │         │      └────────── Tamaño del paquete (sin contar cabecera IP)
│               │     │   │                   │           │                  │         └───────────────── Secuencia
│               │     │   │                   │           │                  └─────────────────────────── Identificador
│               │     │   │                   │           └────────────────────────────────────────────── Tipo de paquete
│               │     │   │                   └────────────────────────────────────────────────────────── IP destino
│               │     │   └────────────────────────────────────────────────────────────────────────────── IP origen
│               │     └────────────────────────────────────────────────────────────────────────────────── Dirección
│               └──────────────────────────────────────────────────────────────────────────────────────── Interfaz de red
└──────────────────────────────────────────────────────────────────────────────────────────────────────── Timestamp del paquete

0x0000:  4500 0054 7450 4000 4001 4ac4 ac1f bf65
         │    │    │    │    │ │  │    │
         │    │    │    │    │ │  │    └────────── IP origen (172.31.191.101)
         │    │    │    │    │ │  └─────────────── Checksum IP (0x4ac4)
         │    │    │    │    │ └────────────────── Protocolo (01 = ICMP)
         │    │    │    │    └──────────────────── TTL (0x40 = 64 decimal)
         │    │    │    └───────────────────────── Flags + Fragment (0x4000 = Don't Fragment)
         │    │    └────────────────────────────── Identification (0x7450)
         │    └─────────────────────────────────── Longitud total (0x0054 = 84 bytes)
         └──────────────────────────────────────── Versión IP (4) + IHL (5 = 20 bytes)

0x0010:  0808 0808 0800 36de dada 0006 6193 8c69
         │         │    │    │    │    │
         │         │    │    │    │    └────────── Timestamp (parte 1)
         │         │    │    │    └─────────────── Sequence number (0006)
         │         │    │    └──────────────────── Identifier (0xdada = 56026)
         │         │    └───────────────────────── Checksum ICMP (0x36de)
         │         └────────────────────────────── Type (08) + Code (00) = Echo Request
         └──────────────────────────────────────── IP destino (8.8.8.8)

0x0020:  0000 0000 eb43 0d00 0000 0000 ffff ffff
         │                             │
         │                             └────────── Inicio del payload
         └──────────────────────────────────────── Timestamp (parte 2)

0x0030:  ffff ffff ffff ffff ffff ffff ffff ffff
0x0040:  ffff ffff ffff ffff ffff ffff ffff ffff
0x0050:  ffff ffff
         │
         └──────────────────────────────────────── Resto del payload
```

## ICMP Echo Reply (respuesta de ping)

```
15:34:09.889643 eth0  In  IP dns.google > 172.31.191.101: ICMP echo reply, id 56026, seq 6, length 64
│               │     │   │                   │           │                │         │      │
│               │     │   │                   │           │                │         │      └──────────── Tamaño del paquete (sin contar cabecera IP)
│               │     │   │                   │           │                │         └─────────────────── Secuencia
│               │     │   │                   │           │                └───────────────────────────── Identificador
│               │     │   │                   │           └────────────────────────────────────────────── Tipo de paquete
│               │     │   │                   └────────────────────────────────────────────────────────── IP destino
│               │     │   └────────────────────────────────────────────────────────────────────────────── IP origen
│               │     └────────────────────────────────────────────────────────────────────────────────── Dirección
│               └──────────────────────────────────────────────────────────────────────────────────────── Interfaz de red
└──────────────────────────────────────────────────────────────────────────────────────────────────────── Timestamp del paquete

0x0000:  4520 0054 0000 0000 7401 caf4 0808 0808
         │    │    │    │    │ │  │    │
         │    │    │    │    │ │  │    └────────── IP origen (8.8.8.8)
         │    │    │    │    │ │  └─────────────── Checksum IP (0xcaf4)
         │    │    │    │    │ └────────────────── Protocolo (01 = ICMP)
         │    │    │    │    └──────────────────── TTL (0x74 = 116 decimal)
         │    │    │    └───────────────────────── Flags + Fragment (0x0000)
         │    │    └────────────────────────────── Identification (0x0000)
         │    └─────────────────────────────────── Longitud total (0x0054 = 84 bytes)
         └──────────────────────────────────────── Versión IP (4) + IHL (5 = 20 bytes)

0x0010:  ac1f bf65 0000 3ede dada 0006 6193 8c69
         │         │    │    │    │    │
         │         │    │    │    │    └────────── Timestamp (parte 1)
         │         │    │    │    └─────────────── Sequence number (0006)
         │         │    │    └──────────────────── Identifier (0xdada = 56026)
         │         │    └───────────────────────── Checksum ICMP (0x3ede)
         │         └────────────────────────────── Type (00) + Code (00) = Echo Reply
         └──────────────────────────────────────── IP destino (172.31.191.101)

0x0020:  0000 0000 eb43 0d00 0000 0000 ffff ffff
         │                             │
         │                             └────────── Inicio del payload
         └──────────────────────────────────────── Timestamp (parte 2)

0x0030:  ffff ffff ffff ffff ffff ffff ffff ffff
0x0040:  ffff ffff ffff ffff ffff ffff ffff ffff
0x0050:  ffff ffff
         │
         └──────────────────────────────────────── Resto del payload
```

## Cambios entre Request y Reply

| Campo           | Request        | Reply          |
|-----------------|----------------|----------------|
| `IP origen`     | 172.31.191.101 | 8.8.8.8        |
| `IP destino`    | 8.8.8.8        | 172.31.191.101 |
| `TTL`           | 64             | 116            |
| `IP Checksum`   | 0x4ac4         | 0xcaf4         |
| `ICMP Type`     | 08 (Request)   | 00 (Reply)     |
| `ICMP Checksum` | 0x36de         | 0x3ede         |
| `Payload`       | idéntico       | idéntico       |
|